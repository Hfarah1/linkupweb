{% extends 'base.html.twig' %}

{% block title %}Postuler à l'offre{% endblock %}

{% block content %}
    <!-- Single Page Header start -->
    <div class="container-fluid page-header py-5">
        <h1 class="text-center text-white display-6">Postuler à l'offre</h1>
        <ol class="breadcrumb justify-content-center mb-0">
            <li class="breadcrumb-item"><a href="{{ path('app_home') }}">Accueil</a></li>
            <li class="breadcrumb-item"><a href="{{ path('app_offre_index') }}">Offres</a></li>
            <li class="breadcrumb-item active text-white">Postuler</li>
        </ol>
    </div>
    <!-- Single Page Header End -->

    <!-- Application Form Start -->
    <div class="container-fluid py-5">
        <div class="container py-5">
            <div class="row g-5">
                <!-- Main Form Column -->
                <div class="col-lg-8">
                    <div class="bg-light rounded p-4">
                        <h2 class="mb-4">Votre candidature</h2>
                        {{ form_start(form, {'attr': {'class': 'needs-validation', 'novalidate': 'novalidate', 'enctype': 'multipart/form-data'}}) }}
                        
                        <!-- CV File Input with PDF Preview -->
                        <div class="form-item mb-4">
                            {{ form_label(form.cv_upload, 'Téléverser votre CV (PDF uniquement)', {
                                'label_attr': {'class': 'form-label mb-3 fw-bold'}
                            }) }}
                            <div class="custom-file">
                                {{ form_widget(form.cv_upload, {
                                    'attr': {
                                        'class': 'form-control',
                                        'accept': 'application/pdf',
                                        'onchange': 'previewPDF(this)'
                                    }
                                }) }}
                                {{ form_errors(form.cv_upload) }}
                            </div>
                            <small class="text-muted">Taille maximale : 2MB</small>
                            
                            <!-- PDF Preview Container -->
                            <div class="mt-3" id="pdfPreviewContainer" style="display:none;">
                                <div class="d-flex align-items-center">
                                    <i class="far fa-file-pdf text-danger me-2" style="font-size: 2rem;"></i>
                                    <div>
                                        <p class="mb-1" id="pdfFileName"></p>
                                        <small class="text-muted" id="pdfFileSize"></small>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-danger" id="viewPdfBtn" style="display:none;">
                                        <i class="far fa-eye me-1"></i> Aperçu
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="removePdfBtn">
                                        <i class="far fa-trash-alt me-1"></i> Supprimer
                                    </button>
                                </div>
                                <iframe id="pdfPreview" class="mt-3 w-100 d-none" style="height: 500px; border: 1px solid #eee;"></iframe>
                            </div>
                        </div>

                        <!-- Cover Letter -->
                        <div class="form-item mb-4">
                            {{ form_label(form.lettre_motivation, 'Lettre de motivation', {
                                'label_attr': {'class': 'form-label mb-3 fw-bold'}
                            }) }}
                            {{ form_widget(form.lettre_motivation, {
                                'attr': {
                                    'class': 'form-control',
                                    'rows': 8,
                                    'placeholder': 'Expliquez pourquoi vous êtes le candidat idéal pour ce poste...'
                                }
                            }) }}
                            {{ form_errors(form.lettre_motivation) }}
                        </div>
                        
                        <div class="row g-4 text-center align-items-center justify-content-center pt-4">
                            <button type="submit" class="btn btn-primary py-3 px-5">
                                <i class="fa fa-paper-plane me-2"></i> Soumettre ma candidature
                            </button>
                        </div>
                        
                        {{ form_end(form) }}
                    </div>
                </div>
                
                <!-- Offer Details Sidebar -->
                <div class="col-lg-4">
                    <div class="bg-light rounded p-4">
                        <h4 class="mb-4">Détails de l'offre</h4>
                        
                        <div class="d-flex align-items-center mb-3">
                            {% if offre.organisationLogo %}
                                <img src="data:image/jpeg;base64,{{ offre.organisationLogo|base64_encode }}" 
                                     class="img-fluid rounded-circle me-3" 
                                     style="width: 80px; height: 80px; object-fit: cover;" 
                                     alt="{{ offre.organisation }}">
                            {% endif %}
                            <div>
                                <h5>{{ offre.titre }}</h5>
                                <p class="mb-0 text-primary">{{ offre.organisation }}</p>
                            </div>
                        </div>
                        
                        <div class="offer-details">
                            <div class="detail-item mb-3">
                                <h6><i class="fa fa-map-marker-alt me-2"></i> Localisation</h6>
                                <p>{{ offre.ville }}, {{ offre.gouvernorat }}</p>
                            </div>
                            
                            <div class="detail-item mb-3">
                                <h6><i class="fa fa-file-contract me-2"></i> Type de contrat</h6>
                                <p>{{ offre.typeContrat }}</p>
                            </div>
                            
                            {% if offre.salaire %}
                            <div class="detail-item mb-3">
                                <h6><i class="fa fa-money-bill-wave me-2"></i> Salaire</h6>
                                <p>{{ offre.salaire|number_format(2, ',', ' ') }} TND</p>
                            </div>
                            {% endif %}
                            
                            <div class="detail-item mb-3">
                                <h6><i class="fa fa-calendar-alt me-2"></i> Date de publication</h6>
                                <p>{{ offre.datePublication|date('d/m/Y') }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Application Form End -->

    <script>
        function previewPDF(input) {
            const container = document.getElementById('pdfPreviewContainer');
            const fileName = document.getElementById('pdfFileName');
            const fileSize = document.getElementById('pdfFileSize');
            const viewBtn = document.getElementById('viewPdfBtn');
            const iframe = document.getElementById('pdfPreview');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // Validate file type
                if (file.type !== 'application/pdf') {
                    alert('Seuls les fichiers PDF sont acceptés');
                    input.value = '';
                    container.style.display = 'none';
                    return;
                }
                
                // Validate file size (2MB)
                if (file.size > 2 * 1024 * 1024) {
                    alert('Le fichier est trop volumineux (max 2MB)');
                    input.value = '';
                    container.style.display = 'none';
                    return;
                }
                
                // Show file info
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                container.style.display = 'block';
                viewBtn.style.display = 'inline-block';
                
                // Set up preview button
                viewBtn.onclick = function() {
                    iframe.src = URL.createObjectURL(file);
                    iframe.classList.remove('d-none');
                };
                
                // Set up remove button
                document.getElementById('removePdfBtn').onclick = function() {
                    input.value = '';
                    container.style.display = 'none';
                    iframe.classList.add('d-none');
                };
            } else {
                container.style.display = 'none';
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>

    <style>
        #pdfPreviewContainer {
            border: 1px dashed #ddd;
            padding: 15px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        #pdfPreview {
            background-color: white;
        }
        .offer-details .detail-item {
            padding-bottom: 15px;
            border-bottom: 1px dashed #eee;
        }
        .offer-details .detail-item:last-child {
            border-bottom: none;
        }
        .custom-file {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .form-control[type="file"] {
            padding: 0.375rem 0.75rem;
        }
    </style>
{% endblock %}